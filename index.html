<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Hello World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hello World">
<meta property="og:url" content="http://gwang-cv.github.io/index.html">
<meta property="og:site_name" content="Hello World">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hello World">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://sites.google.com/site/2013gwang/logss.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Gang Wang</a></h1>
		</hgroup>

		
		<p class="header-subtitle">a computer vision researchGO</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">Home</a></li>
				        
							<li><a href="/archives">Archives</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/gwang-cv" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/messiwang" title="weibo">weibo</a>
					        
								<a class="google" target="_blank" href="https://sites.google.com/site/2013gwang/" title="google">google</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Debug/" style="font-size: 15px;">Debug</a> <a href="/tags/DeepLearning/" style="font-size: 20px;">DeepLearning</a> <a href="/tags/ML/" style="font-size: 10px;">ML</a> <a href="/tags/Mac/" style="font-size: 17.5px;">Mac</a> <a href="/tags/Math/" style="font-size: 10px;">Math</a> <a href="/tags/Matlab/" style="font-size: 10px;">Matlab</a> <a href="/tags/Python/" style="font-size: 12.5px;">Python</a> <a href="/tags/Researcher/" style="font-size: 10px;">Researcher</a> <a href="/tags/python/" style="font-size: 10px;">python</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">Hello, I&#39;m Gang Wang. This is my blog, enjoy it.</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Gang Wang</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="https://sites.google.com/site/2013gwang/logss.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Gang Wang</h1>
			</hgroup>
			
			<p class="header-subtitle">a computer vision researchGO</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">Archives</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/gwang-cv" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/messiwang" title="weibo">weibo</a>
			        
						<a class="google" target="_blank" href="https://sites.google.com/site/2013gwang/" title="google">google</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-Windows下安装labelImg" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/21/Windows下安装labelImg/" class="article-date">
  	<time datetime="2017-09-20T17:53:21.000Z" itemprop="datePublished">2017-09-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/21/Windows下安装labelImg/">Windows下安装labelImg</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.安装必备的Visual Studio 2015，以提供nmake工具</p>
<p>2.在开始菜单中找到Visual Studio Tools &gt; VS2015 x64本机工具命令提示符</p>
<p>3.到pyqt4官方下载sip的源文件</p>
<p>4.编译安装sip</p>
<pre><code>cd C:\sip-<span class="number">4.19</span>.<span class="number">3</span> 
python configure<span class="class">.py</span>
nmake
nmake install
</code></pre><p>5.安装pyqt4，在Windows下不要采用编译安装方法，会掉到坑里。我们使用非官方的安装包，下载地址：<a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/" target="_blank" rel="external">http://www.lfd.uci.edu/~gohlke/pythonlibs/</a>，下载对应的PyQt4‑4.11.4‑cp27‑cp27m‑win_amd64.whl</p>
<pre><code><span class="tag">pip</span> <span class="tag">install</span> <span class="tag">PyQt4</span>‑4<span class="class">.11</span><span class="class">.4</span>‑<span class="tag">cp27</span>‑<span class="tag">cp27m</span>‑<span class="tag">win_amd64</span><span class="class">.whl</span>
</code></pre><p>安装完成之后，将C:\Python27\Lib\site-packages\PyQt4添加到系统路径中</p>
<p>6.安装labelImg，这里编译安装</p>
<pre><code>pyrcc4 -o resources<span class="class">.py</span> resources<span class="class">.qrc</span>
python labelImg.py
</code></pre><p>完成！！</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debug/">Debug</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Caffe训练出错" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/14/Caffe训练出错/" class="article-date">
  	<time datetime="2017-09-14T13:42:31.000Z" itemprop="datePublished">2017-09-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/14/Caffe训练出错/">Caffe训练出错</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Caffe训练出错</p>
<pre><code><span class="tag">F0204</span> 17<span class="pseudo">:40</span><span class="pseudo">:38</span><span class="class">.201807</span> 10866 <span class="rule"><span class="attribute">db_lmdb.hpp</span>:<span class="value"><span class="number">15</span>] Check failed: mdb_status == <span class="number">0</span> (<span class="number">2</span> vs. <span class="number">0</span>) No such file or directory</span></span>
</code></pre><p>You have not set your paths to the LMDB directories correctly.<br>LMDB目录错误,修改prototxt文件的LMDB文件路径</p>
<p>写相对路径不行，写成绝对路径就通过了。。。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debug/">Debug</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-为终端设置Shadowsocks代理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/12/为终端设置Shadowsocks代理/" class="article-date">
  	<time datetime="2017-09-12T09:55:10.000Z" itemprop="datePublished">2017-09-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/12/为终端设置Shadowsocks代理/">为终端设置Shadowsocks代理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>PS：为解决python tweepy连接twitter api超时的问题。</p>
<pre><code>tweepy.<span class="function"><span class="title">api</span><span class="params">(auth,proxy=<span class="string">"localhost:1080"</span>)</span></span>
</code></pre><p>做开发都会经常接触终端，有些时候我们在终端会做一些网络操作，比如下载gradle包等，由于一些你懂我也懂的原因，某些网络操作不是那么理想，这时候我们就需要设置代理来自由地访问网络。<br>Shadowsocks是我们常用的代理工具，它使用socks5协议，而终端很多工具目前只支持http和https等协议，对socks5协议支持不够好，所以我们为终端设置shadowsocks的思路就是将socks协议转换成http协议，然后为终端设置即可。仔细想想也算是适配器模式的一种现实应用吧。<br>想要进行转换，需要借助工具，这里我们采用比较知名的polipo来实现。polipo是一个轻量级的缓存web代理程序。</p>
<p><strong>准备工作</strong></p>
<p>首先需要配置好一个可用的shadowsocks，客户端下载地址：<a href="https://github.com/shadowsocks/shadowsocks/releases" target="_blank" rel="external">https://github.com/shadowsocks/shadowsocks/releases</a></p>
<p>安装和配置ss，请自行搜索解决。</p>
<p>安装<br>Fedora安装</p>
<pre><code>sudo yum <span class="keyword">install</span> polipo
</code></pre><p>Mac下使用Homebrew安装</p>
<pre><code><span class="keyword">brew </span>install polipo
</code></pre><p>Ubuntu安装</p>
<pre><code>sudo apt-<span class="keyword">get</span> install polipo
</code></pre><p><strong>修改配置(Linux)</strong></p>
<p>如下打开配置文件</p>
<pre><code>sudo vim <span class="regexp">/etc/</span>polipo<span class="regexp">/config</span>
</code></pre><p>设置ParentProxy为Shadowsocks，通常情况下本机shadowsocks的地址如下</p>
<pre><code><span class="comment"># Uncomment this if you want to use a parent SOCKS proxy:</span>

<span class="variable">socksParentProxy =</span> <span class="string">"localhost:1080"</span>
<span class="variable">socksProxyType =</span> socks5
</code></pre><p>设置日志输出文件</p>
<pre><code><span class="built_in">log</span>File=/var/<span class="built_in">log</span>/polipo
<span class="built_in">log</span>Level=<span class="number">4</span>
</code></pre><p><strong>修改配置(Mac)</strong></p>
<p>设置每次登陆启动polipo</p>
<pre><code>ln -sfv <span class="regexp">/usr/</span>local<span class="regexp">/opt/</span>polipo<span class="comment">/*.plist ~/Library/LaunchAgents</span>
</code></pre><p>修改文件<code>/usr/local/opt/polipo/homebrew.mxcl.polipo.plist</code>设置parentProxy</p>
<pre><code><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="doctype">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span>
<span class="tag">&lt;<span class="title">plist</span> <span class="attribute">version</span>=<span class="value">"1.0"</span>&gt;</span>
  <span class="tag">&lt;<span class="title">dict</span>&gt;</span>
    <span class="tag">&lt;<span class="title">key</span>&gt;</span>Label<span class="tag">&lt;/<span class="title">key</span>&gt;</span>
    <span class="tag">&lt;<span class="title">string</span>&gt;</span>homebrew.mxcl.polipo<span class="tag">&lt;/<span class="title">string</span>&gt;</span>
    <span class="tag">&lt;<span class="title">key</span>&gt;</span>RunAtLoad<span class="tag">&lt;/<span class="title">key</span>&gt;</span>
    <span class="tag">&lt;<span class="title">true</span>/&gt;</span>
    <span class="tag">&lt;<span class="title">key</span>&gt;</span>KeepAlive<span class="tag">&lt;/<span class="title">key</span>&gt;</span>
    <span class="tag">&lt;<span class="title">true</span>/&gt;</span>
    <span class="tag">&lt;<span class="title">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="title">key</span>&gt;</span>
    <span class="tag">&lt;<span class="title">array</span>&gt;</span>
        <span class="tag">&lt;<span class="title">string</span>&gt;</span>/usr/local/opt/polipo/bin/polipo<span class="tag">&lt;/<span class="title">string</span>&gt;</span>
        <span class="tag">&lt;<span class="title">string</span>&gt;</span>socksParentProxy=localhost:1080<span class="tag">&lt;/<span class="title">string</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">array</span>&gt;</span>
    <span class="comment">&lt;!-- Set `ulimit -n 20480`. The default OS X limit is 256, that's
         not enough for Polipo (displays 'too many files open' errors).
         It seems like you have no reason to lower this limit
         (and unlikely will want to raise it). --&gt;</span>
    <span class="tag">&lt;<span class="title">key</span>&gt;</span>SoftResourceLimits<span class="tag">&lt;/<span class="title">key</span>&gt;</span>
    <span class="tag">&lt;<span class="title">dict</span>&gt;</span>
      <span class="tag">&lt;<span class="title">key</span>&gt;</span>NumberOfFiles<span class="tag">&lt;/<span class="title">key</span>&gt;</span>
      <span class="tag">&lt;<span class="title">integer</span>&gt;</span>20480<span class="tag">&lt;/<span class="title">integer</span>&gt;</span>
    <span class="tag">&lt;/<span class="title">dict</span>&gt;</span>
  <span class="tag">&lt;/<span class="title">dict</span>&gt;</span>
<span class="tag">&lt;/<span class="title">plist</span>&gt;</span>
</code></pre><p>修改的地方是增加了<code>&lt;string&gt;socksParentProxy=localhost:1080&lt;/string&gt;</code></p>
<p><strong>启动（Linux）</strong></p>
<p>先关闭正在运行的polipo，然后再次启动</p>
<pre><code>sudo <span class="keyword">service</span> polipo <span class="literal">stop</span>
sudo <span class="keyword">service</span> polipo <span class="literal">start</span>
</code></pre><p><strong>启动(Mac)</strong></p>
<pre><code>launchctl unload ~/Library/LaunchAgents/homebrew<span class="class">.mxcl</span><span class="class">.polipo</span><span class="class">.plist</span>
launchctl load ~/Library/LaunchAgents/homebrew<span class="class">.mxcl</span><span class="class">.polipo</span><span class="class">.plis</span>
</code></pre><p>注意：请确保Shadowsocks正常工作。</p>
<p><strong>验证及使用</strong></p>
<p>安装完成就需要进行验证是否work。这里展示一个最简单的验证方法，打开终端，如下执行</p>
<pre><code><span class="number">07</span>:<span class="number">56</span>:<span class="number">24</span>-<span class="keyword">androidyue/var/log$ </span>curl <span class="literal">ip</span>.gs
当前 <span class="literal">IP</span>：<span class="number">125</span>.<span class="number">39</span>.<span class="number">112</span>.<span class="number">15</span> 来自：中国天津天津 联通
<span class="number">08</span>:<span class="number">09</span>:<span class="number">23</span>-<span class="keyword">androidyue/var/log$ </span>http_proxy<span class="label">=http</span>://localhost:<span class="number">8123</span> curl <span class="literal">ip</span>.gs
当前 <span class="literal">IP</span>：<span class="number">210</span>.<span class="number">140</span>.<span class="number">193</span>.<span class="number">128</span> 来自：日本日本
</code></pre><p>如上所示，为某个命令设置代理，前面加上http_proxy=<a href="http://localhost:8123" target="_blank" rel="external">http://localhost:8123</a> 后接命令即可。<br>注：8123是polipo的默认端口，如有需要，可以修改成其他有效端口。</p>
<p><strong>设置别名</strong></p>
<p>bash中有一个很好的东西，就是别名alias. Linux用户修改~/.bashrc，Mac用户修改~/.bash_profile文件，增加如下设置</p>
<pre><code><span class="keyword">alias</span> <span class="title">hp</span>=<span class="string">"http_proxy=http://localhost:8123"</span>
</code></pre><p>然后Linux用户执行source ~/.bashrc，Mac用户执行source ~/.bash_profile</p>
<p><strong>测试使用</strong></p>
<pre><code><span class="number">20</span>:<span class="number">39</span>:<span class="number">39</span>-<span class="keyword">androidyue~$ </span>curl <span class="literal">ip</span>.gs
当前 <span class="literal">IP</span>：<span class="number">125</span>.<span class="number">39</span>.<span class="number">112</span>.<span class="number">14</span> 来自：中国天津天津 联通
<span class="number">20</span>:<span class="number">39</span>:<span class="number">44</span>-<span class="keyword">androidyue~$ </span>hp curl <span class="literal">ip</span>.gs
当前 <span class="literal">IP</span>：<span class="number">210</span>.<span class="number">140</span>.<span class="number">193</span>.<span class="number">128</span> 来自：日本日本 
<span class="number">20</span>:<span class="number">39</span>:<span class="number">48</span>-<span class="keyword">androidyue~$ </span>
</code></pre><p><strong>当前会话全局设置</strong></p>
<p>如果嫌每次为每一个命令设置代理比较麻烦，可以为当前会话设置全局的代理。即使用export http_proxy=<a href="http://localhost:8123即可。" target="_blank" rel="external">http://localhost:8123即可。</a> 如果想撤销当前会话的http_proxy代理，使用 unset http_proxy 即可。 示例效果如下</p>
<pre><code><span class="number">21</span>:<span class="number">29</span>:<span class="number">49</span>-<span class="keyword">androidyue~$ </span>curl <span class="literal">ip</span>.gs
当前 <span class="literal">IP</span>：<span class="number">125</span>.<span class="number">39</span>.<span class="number">112</span>.<span class="number">14</span> 来自：中国天津天津 联通
<span class="number">21</span>:<span class="number">29</span>:<span class="number">52</span>-<span class="keyword">androidyue~$ </span><span class="preprocessor">export</span> http_proxy<span class="label">=http</span>://localhost:<span class="number">8123</span>
<span class="number">21</span>:<span class="number">30</span>:<span class="number">07</span>-<span class="keyword">androidyue~$ </span>curl <span class="literal">ip</span>.gs
当前 <span class="literal">IP</span>：<span class="number">210</span>.<span class="number">140</span>.<span class="number">193</span>.<span class="number">128</span> 来自：日本日本 
<span class="number">21</span>:<span class="number">30</span>:<span class="number">12</span>-<span class="keyword">androidyue~$ </span>unset http_proxy
<span class="number">21</span>:<span class="number">30</span>:<span class="number">37</span>-<span class="keyword">androidyue~$ </span>curl <span class="literal">ip</span>.gs
当前 <span class="literal">IP</span>：<span class="number">125</span>.<span class="number">39</span>.<span class="number">112</span>.<span class="number">14</span> 来自：中国天津天津 联通
</code></pre><p>如果想要更长久的设置代理，可以将export http_proxy=<a href="http://localhost:8123加入.bashrc或者.bash_profile文件" target="_blank" rel="external">http://localhost:8123加入.bashrc或者.bash_profile文件</a></p>
<p><strong>设置Git代理</strong><br>复杂一些的设置Git代理</p>
<pre><code>git clone <span class="string">https:</span><span class="comment">//android.googlesource.com/tools/repo --config http.proxy=localhost:8123</span>

Cloning into <span class="string">'repo'</span>...
<span class="string">remote:</span> Counting <span class="string">objects:</span> <span class="number">135</span>, done
<span class="string">remote:</span> Finding <span class="string">sources:</span> <span class="number">100</span>% (<span class="number">135</span>/<span class="number">135</span>)
<span class="string">remote:</span> Total <span class="number">3483</span> (delta <span class="number">1956</span>), reused <span class="number">3483</span> (delta <span class="number">1956</span>)
Receiving <span class="string">objects:</span> <span class="number">100</span>% (<span class="number">3483</span><span class="regexp">/3483), 2.63 MiB | 492 KiB/</span>s, done.
Resolving <span class="string">deltas:</span> <span class="number">100</span>% (<span class="number">1956</span>/<span class="number">1956</span>), done.
</code></pre><p>其实这样还是比较复杂，因为需要记忆的东西比较多，下面是一个更简单的实现<br>首先，在.bashrc或者.bash_profile文件加入这一句。</p>
<pre><code><span class="setting">gp=<span class="value"><span class="string">" --config http.proxy=localhost:8123"</span></span></span>
</code></pre><p>然后执行source操作，更新当前bash配置。</p>
<p>更简单的使用git的方法</p>
<pre><code>git clone  <span class="string">https:</span><span class="comment">//android.googlesource.com/tools/repo $gp</span>

Cloning into <span class="string">'repo'</span>...
<span class="string">remote:</span> Counting <span class="string">objects:</span> <span class="number">135</span>, done
<span class="string">remote:</span> Finding <span class="string">sources:</span> <span class="number">100</span>% (<span class="number">135</span>/<span class="number">135</span>)
<span class="string">remote:</span> Total <span class="number">3483</span> (delta <span class="number">1956</span>), reused <span class="number">3483</span> (delta <span class="number">1956</span>)
Receiving <span class="string">objects:</span> <span class="number">100</span>% (<span class="number">3483</span><span class="regexp">/3483), 2.63 MiB | 483 KiB/</span>s, done.
Resolving <span class="string">deltas:</span> <span class="number">100</span>% (<span class="number">1956</span>/<span class="number">1956</span>), done.
</code></pre><p>End</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debug/">Debug</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-解决opencv无法读取视频数据(Ubuntu)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/10/解决opencv无法读取视频数据(Ubuntu)/" class="article-date">
  	<time datetime="2017-09-10T09:25:51.000Z" itemprop="datePublished">2017-09-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/10/解决opencv无法读取视频数据(Ubuntu)/">解决opencv无法读取视频数据(Ubuntu)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>错误描述：</strong></p>
<pre><code>OpenCV <span class="keyword">Error</span>: Unspecified <span class="keyword">error</span> (The <span class="keyword">function</span> <span class="keyword">is</span> <span class="keyword">not</span> implemented. Rebuild
 the library <span class="keyword">with</span> Windows, GTK+ <span class="number">2.</span>x <span class="keyword">or</span> Carbon support. <span class="keyword">If</span> you are <span class="keyword">on</span> Ubuntu
  <span class="keyword">or</span> Debian, install libgtk2.0-dev <span class="keyword">and</span> pkg-config, <span class="keyword">then</span> re-run cmake <span class="keyword">or</span> 
  configure script) <span class="keyword">in</span> cvNamedWindow, file /io/opencv/modules/highgui/src/window.cpp, line <span class="number">565</span>
Traceback (most recent <span class="keyword">call</span> last):
  File <span class="string">"video_tools/demo.py"</span>, line <span class="number">103</span>, <span class="keyword">in</span> &lt;<span class="keyword">module</span>&gt;
    cv2.namedWindow(<span class="comment">'ret',0)</span>
cv2.<span class="keyword">error</span>: /io/opencv/modules/highgui/src/window.cpp:<span class="number">565</span>: <span class="keyword">error</span>: (-<span class="number">2</span>) The 
<span class="keyword">function</span> <span class="keyword">is</span> <span class="keyword">not</span> implemented. Rebuild the library <span class="keyword">with</span> Windows, GTK+ <span class="number">2.</span>x <span class="keyword">or</span>
 Carbon support. <span class="keyword">If</span> you are <span class="keyword">on</span> Ubuntu <span class="keyword">or</span> Debian, install libgtk2.0-dev <span class="keyword">and</span> 
 pkg-config, <span class="keyword">then</span> re-run cmake <span class="keyword">or</span> configure script <span class="keyword">in</span> <span class="keyword">function</span> cvNamedWindow
</code></pre><p><strong>分析：</strong></p>
<p>在Ubuntu16.04下安装OpenCV3.2之前，确实已经提前安装了各种依赖包，特别是libgtk2.0-dev and pkg-config已经确认安装，通过在python下使用<code>cv2.getBuildInformation()</code>查看：</p>
<pre><code>GUI: 
    QT:                          <span class="keyword">NO</span>
    GTK+:                        <span class="keyword">NO</span>
    GThread :                    YES (ver 2.12.3)
    GtkGlExt:                    <span class="keyword">NO</span>
    OpenGL support:              <span class="keyword">NO</span>
    VTK support:                 <span class="keyword">NO</span>

  Media I/O: 
    ZLib:                        zlib (ver 1.2.8)
    JPEG:                        libjpeg (ver 90)
    WEBP:                        build (ver 0.3.1)
    PNG:                         build (ver 1.6.24)
    TIFF:                        build (ver 42 - 4.0.2)
    JPEG 2000:                   build (ver 1.900.1)
    OpenEXR:                     build (ver 1.7.1)
    GDAL:                        <span class="keyword">NO</span>
    GDCM:                        <span class="keyword">NO</span>

  Video I/O:
    DC1394 1.x:                  <span class="keyword">NO</span>
    DC1394 2.x:                  <span class="keyword">NO</span>
    FFMPEG:                      <span class="keyword">NO</span>
      avcodec:                   <span class="keyword">NO</span>
      avformat:                  <span class="keyword">NO</span>
      avutil:                    <span class="keyword">NO</span>
      swscale:                   <span class="keyword">NO</span>
      avresample:                <span class="keyword">NO</span>
    GStreamer:                   <span class="keyword">NO</span>
    OpenNI:                      <span class="keyword">NO</span>
    OpenNI PrimeSensor Modules:  <span class="keyword">NO</span>
    OpenNI2:                     <span class="keyword">NO</span>
    PvAPI:                       <span class="keyword">NO</span>
    GigEVisionSDK:               <span class="keyword">NO</span>
    Aravis SDK:                  <span class="keyword">NO</span>
    UniCap:                      <span class="keyword">NO</span>
    UniCap ucil:                 <span class="keyword">NO</span>
    V4L/V4L2:                    <span class="keyword">NO</span>/<span class="keyword">NO</span>
    XIMEA:                       <span class="keyword">NO</span>
    Xine:                        <span class="keyword">NO</span>
    gPhoto2:                     <span class="keyword">NO</span>

  Parallel framework:            pthreads

  Other third-party libraries:
    <span class="keyword">Use</span> IPP:                     <span class="keyword">NO</span>
    <span class="keyword">Use</span> IPP Async:               <span class="keyword">NO</span>
    <span class="keyword">Use</span> VA:                      <span class="keyword">NO</span>
    <span class="keyword">Use</span> Intel VA-API/OpenCL:     <span class="keyword">NO</span>
    <span class="keyword">Use</span> Lapack:                  <span class="keyword">NO</span>
    <span class="keyword">Use</span> Eigen:                   <span class="keyword">NO</span>
    <span class="keyword">Use</span> Cuda:                    <span class="keyword">NO</span>
    <span class="keyword">Use</span> OpenCL:                  YES
    <span class="keyword">Use</span> OpenVX:                  <span class="keyword">NO</span>
    <span class="keyword">Use</span> custom HAL:              <span class="keyword">NO</span>

  OpenCL:                        &lt;Dynamic loading of OpenCL library&gt;
    <span class="keyword">Include</span> path:                /io/opencv/3rdparty/<span class="keyword">include</span>/opencl/1.2
    <span class="keyword">Use</span> AMDFFT:                  <span class="keyword">NO</span>
    <span class="keyword">Use</span> AMDBLAS:                 <span class="keyword">NO</span>

  Python 2:
    Interpreter:                 python (ver 2.7.13)
    Libraries:                   
    numpy:                       /opt/python/cp27-cp27mu/lib/python2.7/site-packages/numpy/core/<span class="keyword">include</span> (ver 1.11.1)
    packages path:               /opt/python/cp27-cp27mu/lib/python2.7/site-packages

  Python 3:
    Interpreter:                 <span class="keyword">NO</span>

  Python (<span class="keyword">for</span> build):            python

  Java:
    ant:                         <span class="keyword">NO</span>
    JNI:                         <span class="keyword">NO</span>
    Java wrappers:               <span class="keyword">NO</span>
    Java tests:                  <span class="keyword">NO</span>

  Matlab:                        Matlab not found or implicitly disabled

  Tests and samples:
    Tests:                       <span class="keyword">NO</span>
    Performance tests:           <span class="keyword">NO</span>
    C/C++ Examples:              <span class="keyword">NO</span>

  Install path:                  /usr/<span class="keyword">local</span>

  cvconfig.<span class="keyword">h</span> is <span class="keyword">in</span>:              /io/opencv/build
-----------------------------------------------------------------
</code></pre><p>安装官方给出的建议，重新编译，特别注意一些开关要设置下：</p>
<pre><code>sudo apt-get -y install libopencv-dev build-essential checkinstall cmake pkg-config yasm  libjpeg-dev libjasper-dev libavcodec-dev libavformat-dev libswscale-dev libdc1394-22-dev  libgstreamer0.10-dev libgstreamer-plugins-base0.10-dev libv4l-dev python-dev python-numpy libtbb-dev libqt4-dev libgtk2.0-dev libfaac-dev libmp3lame-dev libopencore-amrnb-dev libopencore-amrwb-dev libtheora-dev libvorbis-dev libxvidcore-dev x264 v4l-utils libtiff5-dev libjpeg62-dev ffmpeg libatlas-base-dev gfortran

cmake 
-<span class="ruby"><span class="constant">D</span> <span class="constant">CMAKE_BUILD_TYPE</span>=<span class="constant">RELEASE</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">CMAKE_INSTALL_PREFIX</span>=<span class="regexp">/usr/local</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">FORCE_VTK</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">BUILD_NEW_PYTHON_SUPPORT</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">INSTALL_C_EXAMPLES</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">INSTALL_PYTHON_EXAMPLES</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">WITH_TBB</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">WITH_V4L</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">WITH_QT</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">WITH_OPENGL</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">WITH_CUBLAS</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">CUDA_NVCC_FLAGS</span>=<span class="string">"-D_FORCE_INLINES"</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">WITH_GDAL</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">WITH_XINE</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">BUILD_EXAMPLES</span>=<span class="constant">ON</span> \
</span>-<span class="ruby"><span class="constant">D</span> <span class="constant">WITH_FFMPEG</span>=<span class="constant">ON</span> ..</span>
</code></pre><p>   make -j32<br>   make install</p>
<p>但是我发现，在重新编译后安装后的<code>cv2.so</code>，引入到python后得到的信息如下：</p>
<pre><code>GUI: 
    QT 4.x:                      YES (ver 4.8.7 EDITION = OpenSource)
    QT OpenGL support:           YES (/usr/lib/x86_64-linux-gnu/libQtOpenGL.<span class="keyword">so</span>)
    OpenGL support:              YES (/usr/lib/x86_64-linux-gnu/libGLU.<span class="keyword">so</span> /usr/lib/x86_64-linux-gnu/libGL.<span class="keyword">so</span>)
    VTK support:                 <span class="keyword">NO</span>

  Media I/O: 
    ZLib:                        /usr/lib/x86_64-linux-gnu/libz.<span class="keyword">so</span> (ver 1.2.8)
    JPEG:                        /usr/lib/x86_64-linux-gnu/libjpeg.<span class="keyword">so</span> (ver )
    WEBP:                        build (ver 0.3.1)
    PNG:                         /usr/lib/x86_64-linux-gnu/libpng.<span class="keyword">so</span> (ver 1.2.54)
    TIFF:                        /usr/lib/x86_64-linux-gnu/libtiff.<span class="keyword">so</span> (ver 42 - 4.0.6)
    JPEG 2000:                   /usr/lib/x86_64-linux-gnu/libjasper.<span class="keyword">so</span> (ver 1.900.1)
    OpenEXR:                     /usr/lib/x86_64-linux-gnu/libImath.<span class="keyword">so</span> /usr/lib/x86_64-linux-gnu/libIlmImf.<span class="keyword">so</span> /usr/lib/x86_64-linux-gnu/libIex.<span class="keyword">so</span> /usr/lib/x86_64-linux-gnu/libHalf.<span class="keyword">so</span> /usr/lib/x86_64-linux-gnu/libIlmThread.<span class="keyword">so</span> (ver 2.2.0)
    GDAL:                        <span class="keyword">NO</span>
    GDCM:                        <span class="keyword">NO</span>

  Video I/O:
    DC1394 1.x:                  <span class="keyword">NO</span>
    DC1394 2.x:                  YES (ver 2.2.4)
    FFMPEG:                      YES
      avcodec:                   YES (ver 56.60.100)
      avformat:                  YES (ver 56.40.101)
      avutil:                    YES (ver 54.31.100)
      swscale:                   YES (ver 3.1.101)
      avresample:                <span class="keyword">NO</span>
    GStreamer:                   
      base:                      YES (ver 0.10.36)
      video:                     YES (ver 0.10.36)
      <span class="keyword">app</span>:                       YES (ver 0.10.36)
      riff:                      YES (ver 0.10.36)
      pbutils:                   YES (ver 0.10.36)
    OpenNI:                      <span class="keyword">NO</span>
    OpenNI PrimeSensor Modules:  <span class="keyword">NO</span>
    OpenNI2:                     <span class="keyword">NO</span>
    PvAPI:                       <span class="keyword">NO</span>
    GigEVisionSDK:               <span class="keyword">NO</span>
    Aravis SDK:                  <span class="keyword">NO</span>
    UniCap:                      <span class="keyword">NO</span>
    UniCap ucil:                 <span class="keyword">NO</span>
    V4L/V4L2:                    <span class="keyword">NO</span>/YES
    XIMEA:                       <span class="keyword">NO</span>
    Xine:                        <span class="keyword">NO</span>
    gPhoto2:                     <span class="keyword">NO</span>

  Parallel framework:            TBB (ver 4.4 interface 9002)

  Other third-party libraries:
    <span class="keyword">Use</span> IPP:                     9.0.1 [9.0.1]
         at:                     /home/gwang/opencv-3.2.0/build/3rdparty/ippicv/ippicv_lnx
    <span class="keyword">Use</span> IPP Async:               <span class="keyword">NO</span>
    <span class="keyword">Use</span> VA:                      <span class="keyword">NO</span>
    <span class="keyword">Use</span> Intel VA-API/OpenCL:     <span class="keyword">NO</span>
    <span class="keyword">Use</span> Lapack:                  YES (/opt/intel/mkl/lib/intel64/libmkl_core.<span class="keyword">so</span> /opt/intel/mkl/lib/intel64/libmkl_intel_lp64.<span class="keyword">so</span> /opt/intel/mkl/lib/intel64/libmkl_sequential.<span class="keyword">so</span> /opt/intel/mkl/lib/intel64/libmkl_core.<span class="keyword">so</span> /opt/intel/mkl/lib/intel64/libmkl_intel_lp64.<span class="keyword">so</span> /opt/intel/mkl/lib/intel64/libmkl_sequential.<span class="keyword">so</span> /opt/intel/mkl/lib/intel64/libmkl_core.<span class="keyword">so</span> /opt/intel/mkl/lib/intel64/libmkl_intel_lp64.<span class="keyword">so</span> /opt/intel/mkl/lib/intel64/libmkl_sequential.<span class="keyword">so</span> -lpthread -lm -ldl)
    <span class="keyword">Use</span> Eigen:                   <span class="keyword">NO</span>
    <span class="keyword">Use</span> Cuda:                    YES (ver 8.0)
    <span class="keyword">Use</span> OpenCL:                  YES
    <span class="keyword">Use</span> OpenVX:                  <span class="keyword">NO</span>
    <span class="keyword">Use</span> custom HAL:              <span class="keyword">NO</span>

  NVIDIA CUDA
    <span class="keyword">Use</span> CUFFT:                   YES
    <span class="keyword">Use</span> CUBLAS:                  YES
    <span class="keyword">USE</span> NVCUVID:                 <span class="keyword">NO</span>
    NVIDIA GPU <span class="keyword">arch</span>:             20 30 35 37 50 52 60 61
    NVIDIA PTX archs:
    <span class="keyword">Use</span> fast math:               <span class="keyword">NO</span>

  OpenCL:                        &lt;Dynamic loading of OpenCL library&gt;
    <span class="keyword">Include</span> path:                /home/gwang/opencv-3.2.0/3rdparty/<span class="keyword">include</span>/opencl/1.2
    <span class="keyword">Use</span> AMDFFT:                  <span class="keyword">NO</span>
    <span class="keyword">Use</span> AMDBLAS:                 <span class="keyword">NO</span>

  Python 2:
    Interpreter:                 /usr/bin/python2.7 (ver 2.7.12)
    Libraries:                   /usr/lib/x86_64-linux-gnu/libpython2.7.<span class="keyword">so</span> (ver 2.7.12)
    numpy:                       /usr/<span class="keyword">local</span>/lib/python2.7/dist-packages/numpy/core/<span class="keyword">include</span> (ver 1.11.0)
    packages path:               lib/python2.7/dist-packages

  Python 3:
    Interpreter:                 /usr/bin/python3 (ver 3.5.2)

  Python (<span class="keyword">for</span> build):            /usr/bin/python2.7

  Java:
    ant:                         <span class="keyword">NO</span>
    JNI:                         /usr/lib/jvm/default-java/<span class="keyword">include</span> /usr/lib/jvm/default-java/<span class="keyword">include</span>/linux /usr/lib/jvm/default-java/<span class="keyword">include</span>
    Java wrappers:               <span class="keyword">NO</span>
    Java tests:                  <span class="keyword">NO</span>

  Matlab:
    mex:                         /usr/<span class="keyword">local</span>/MATLAB/R2014a/bin/mex
    Compiler/generator:          Not working (bindings will not be generated)

  Documentation:
    Doxygen:                     <span class="keyword">NO</span>

  Tests and samples:
    Tests:                       YES
    Performance tests:           YES
    C/C++ Examples:              YES

  Install path:                  /usr/<span class="keyword">local</span>

  cvconfig.<span class="keyword">h</span> is <span class="keyword">in</span>:              /home/gwang/opencv-3.2.0/build
-----------------------------------------------------------------
</code></pre><p>同样在终端内python控制台得到的information和.py文件内得到information居然不一样，仔细分析发现这两个不是一个东西，想想是不是通过其他方式安装了opencv，通过尝试如下命令发现了这个bug：</p>
<pre><code>sudo pip uninstall opencv-python

The directory '/home/xxx/.cache/pip/http' <span class="keyword">or</span> <span class="keyword">its</span> parent directory <span class="keyword">is</span> <span class="keyword">not</span> owned <span class="keyword">by</span> <span class="keyword">the</span> current user <span class="keyword">and</span> <span class="keyword">the</span> cache has been disabled. Please check <span class="keyword">the</span> permissions <span class="keyword">and</span> owner <span class="keyword">of</span> <span class="keyword">that</span> directory. If executing pip <span class="keyword">with</span> sudo, you may want sudo's -H flag.
Uninstalling opencv-python-<span class="number">3.2</span>.0.7:
  /home/xxx/.<span class="keyword">local</span>/LICENSE-<span class="number">3</span>RD-PARTY.txt
  /home/xxx/.<span class="keyword">local</span>/LICENSE.txt
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/cv2/__init__.py
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/cv2/__init__.pyc
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/cv2/cv2.so
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/opencv_python-<span class="number">3.2</span>.0.7.dist-info/DESCRIPTION.rst
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/opencv_python-<span class="number">3.2</span>.0.7.dist-info/INSTALLER
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/opencv_python-<span class="number">3.2</span>.0.7.dist-info/METADATA
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/opencv_python-<span class="number">3.2</span>.0.7.dist-info/RECORD
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/opencv_python-<span class="number">3.2</span>.0.7.dist-info/WHEEL
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/opencv_python-<span class="number">3.2</span>.0.7.dist-info/metadata.json
  /home/xxx/.<span class="keyword">local</span>/lib/python2.7/site-packages/opencv_python-<span class="number">3.2</span>.0.7.dist-info/top_level.txt
Proceed (y/n)? 
y
  Successfully uninstalled opencv-python-<span class="number">3.2</span>.0.7
The directory '/home/xx/.cache/pip/http' <span class="keyword">or</span> <span class="keyword">its</span> parent directory <span class="keyword">is</span> <span class="keyword">not</span> owned <span class="keyword">by</span> <span class="keyword">the</span> current user <span class="keyword">and</span> <span class="keyword">the</span> cache has been disabled. Please check <span class="keyword">the</span> permissions <span class="keyword">and</span> owner <span class="keyword">of</span> <span class="keyword">that</span> directory. If executing pip <span class="keyword">with</span> sudo, you may want sudo's -H flag.
</code></pre><p>卸载后，到终端python命令行内进行测试：</p>
<pre><code><span class="prompt">&gt;&gt;</span>&gt;python
<span class="prompt">&gt;&gt;</span>&gt;import cv2
<span class="prompt">&gt;&gt;</span>&gt;<span class="constant">Traceback</span> (most recent call last)<span class="symbol">:</span>
  <span class="constant">File</span> <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;<span class="class"><span class="keyword">module</span>&gt;</span>
<span class="constant">ImportError</span><span class="symbol">:</span> <span class="constant">No</span> <span class="class"><span class="keyword">module</span> <span class="title">named</span> <span class="title">cv2</span></span>
</code></pre><p>没有找到cv2，那么要把编译安装后的cv2.so重新链接下：</p>
<pre><code>cd <span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>python2.7/dist-packages
sudo ln -s <span class="regexp">/home/</span>xxx<span class="regexp">/opencv3.2/</span>build<span class="regexp">/lib/</span>cv2.so cv2.so
</code></pre><p>至此，终于搞定这个问题！！</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debug/">Debug</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-编译ab压力测试并发(Ubuntu)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/08/编译ab压力测试并发(Ubuntu)/" class="article-date">
  	<time datetime="2017-09-08T07:50:31.000Z" itemprop="datePublished">2017-09-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/08/编译ab压力测试并发(Ubuntu)/">编译ab压力测试并发(Ubuntu)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>Abstract</strong></p>
<p>用深度学习框架caffe做的project，需要对其进行并发数请求数的压力测试，找到了apachebench(ab)简单的压力测试工具，但在Ubuntu下通过apt-get安装的ab，在处理请求数高于200,300左右的时候就会报错终止<code>apr_socket_recv: Connection reset by peer</code>，查阅资料显示需要对ab进行重新修改并编译后方可破除这个问题（无论是如何安装的，都要从头开始重新修改编译安装）。</p>
<p><strong>1.下载所需要的源码</strong></p>
<p>apr和apr-util下载：<a href="http://apr.apache.org/download.cgi" target="_blank" rel="external">http://apr.apache.org/download.cgi </a></p>
<p>ab-standalone源码下载:<a href="https://code.google.com/p/apachebench-standalone/downloads/list" target="_blank" rel="external">https://code.google.com/p/apachebench-standalone/downloads/list</a></p>
<p><strong>2.编译安装</strong></p>
<p>分别解压三个压缩包：</p>
<pre><code>ab-standalone-<span class="number">0.1</span><span class="class">.tar</span><span class="class">.bz2</span> 
apr-<span class="number">1</span><span class="class">.x</span><span class="class">.x</span><span class="class">.tar</span><span class="class">.gz</span>  
apr-util-<span class="number">1</span><span class="class">.x</span><span class="class">.x</span><span class="class">.tar</span><span class="class">.gz</span>  
</code></pre><p><strong>a.编译apr</strong></p>
<pre><code><span class="variable">$ </span>cd apr
<span class="variable">$ </span>./configure  
<span class="variable">$ </span>make  
<span class="variable">$ </span>sudo make install  
</code></pre><p><strong>b.编译apr-util</strong></p>
<pre><code><span class="char">$ </span>cd apr-util 
<span class="char">$ </span>./configure --with-apr=/usr/local/apr  
<span class="char">$ </span>make  
<span class="char">$ </span>sudo make install  
</code></pre><p><strong>c.编译ab</strong></p>
<p>修改ab-standalone/ab.c文件</p>
<pre><code>$ <span class="keyword">cd</span> <span class="keyword">ab</span>/<span class="keyword">ab</span>-standalone  
$ <span class="keyword">vim</span> <span class="keyword">ab</span>.<span class="keyword">c</span>  
</code></pre><p>到1380行修改成如下:</p>
<pre><code><span class="comment">/* catch legitimate fatal apr_socket_recv errors */</span>  
<span class="keyword">else</span> <span class="keyword">if</span> <span class="params">(status != APR_SUCCESS)</span> {  
    err_recv++;  
    <span class="keyword">if</span> <span class="params">(recverrok)</span> {  
        bad++;  
        close_connection<span class="params">(c)</span>;  
        <span class="keyword">if</span> <span class="params">(verbosity &gt;= <span class="number">1</span>)</span> {  
            char buf[<span class="number">120</span>];  
            fprintf<span class="params">(stderr,<span class="string">"%s: %s (%d)\n"</span>, <span class="string">"apr_socket_recv"</span>, apr_strerror<span class="params">(status, buf, sizeof buf)</span>, status)</span>;  
        }  
        return;  
    } <span class="keyword">else</span> {  
        <span class="comment">//apr_err("apr_socket_recv", status);   // begin </span>
        bad++;  
        close_connection<span class="params">(c)</span>;  
        return;      <span class="comment">// end </span>
    }  
}  
</code></pre><p><em>然后在编译之前将apr-util/include/下的apr_base64.h和apu.h拷贝到ab-standalone文件夹内，否则找不到头文件</em></p>
<p>开始编译ab</p>
<pre><code>$ <span class="keyword">make</span> apr-skeleton
$ sudo <span class="keyword">make</span> <span class="keyword">ab</span>
$ sudo <span class="keyword">cp</span> <span class="keyword">ab</span> apr-skeleton /usr/local/bin/
</code></pre><hr>
<p><strong>3.注意</strong></p>
<p>连接库文件问题：</p>
<p>终端中安装： libapr1，否则会出错找不到apr-1：<code>sudo apt-get install libapr1</code></p>
<p>或者从编译后的usr/local/apr/lib下面将几个文件拷贝到/usr/lib/x86_64-linux-gnu下做链接：</p>
<pre><code>sudo cp <span class="regexp">/usr/</span>local<span class="regexp">/apr/</span>lib<span class="regexp">/libaprutil-1.a /</span>usr<span class="regexp">/lib/</span>x86_64-linux-gnu/
sudo cp <span class="regexp">/usr/</span>local<span class="regexp">/apr/</span>lib<span class="regexp">/liaprutil-1.so /</span>usr<span class="regexp">/lib/</span>x86_64-linux-gnu/
sudo cp <span class="regexp">/usr/</span>local<span class="regexp">/apr/</span>lib<span class="regexp">/libaprutil-1.so.0.6.0 /</span>usr<span class="regexp">/lib/</span>x86_64-linux-gnu/
sudo cp <span class="regexp">/usr/</span>local<span class="regexp">/apr/</span>lib<span class="regexp">/libaprutil-1.la /</span>usr<span class="regexp">/lib/</span>x86_64-linux-gnu/
cd <span class="regexp">/usr/</span>lib<span class="regexp">/x86_64-linux-gnu/</span>
sudo ln -s libaprutil-<span class="number">1.</span>so.0.6.0 libaprutil-<span class="number">1.</span>so.0
sudo ldconfig
</code></pre><p>同理，不选择apt-get安装，而如此设置libapr1.so.0即可。</p>
<hr>
<p><strong>4.测试</strong></p>
<p>查看版本：</p>
<pre><code><span class="variable">$ </span>ab -<span class="constant">V</span>
<span class="constant">This </span>is <span class="constant">ApacheBench,</span> <span class="constant">Version </span><span class="number">2.3</span> &lt;<span class="variable">$Revision</span><span class="variable">$&gt;</span>
<span class="constant">Copyright </span><span class="number">1996</span> <span class="constant">Adam Twiss,</span> <span class="constant">Zeus Technology Ltd,</span> <span class="symbol">http:</span>/<span class="regexp">/www.zeustech.net/</span>
<span class="constant">Licensed </span>to <span class="constant">The Apache Software Foundation,</span> <span class="symbol">http:</span>/<span class="regexp">/www.apache.org/</span>
</code></pre><p>测试并发数：</p>
<pre><code>ab -n <span class="number">500</span> -c <span class="number">500</span> <span class="number">127.0</span>.0.1  # -n请求数，-c并发数，-n&gt;=-c

This is ApacheBench, Version <span class="number">2.3</span> &lt;$Revision$&gt;
Copyright <span class="number">1996</span> Adam Twiss, Zeus Technology Ltd, <span class="string">http:</span><span class="comment">//www.zeustech.net/</span>
Licensed to The Apache Software Foundation, <span class="string">http:</span><span class="comment">//www.apache.org/</span>

Benchmarking <span class="number">127.0</span>.0.1 (be patient)
Completed <span class="number">100</span> requests
Completed <span class="number">200</span> requests
Completed <span class="number">300</span> requests
Completed <span class="number">400</span> requests
Completed <span class="number">500</span> requests
Finished <span class="number">500</span> requests


Server <span class="string">Software:</span>        TornadoServer/<span class="number">4.5</span>.2
Server <span class="string">Hostname:</span>        <span class="number">127.0</span>.0.1
Server <span class="string">Port:</span>            <span class="number">1000</span>

Document <span class="string">Path:</span>          /
Document <span class="string">Length:</span>        <span class="number">221727</span> bytes

Concurrency <span class="string">Level:</span>      <span class="number">500</span>
Time taken <span class="keyword">for</span> <span class="string">tests:</span>   <span class="number">215.661</span> seconds
Complete <span class="string">requests:</span>      <span class="number">500</span>
Failed <span class="string">requests:</span>        <span class="number">1023</span>
   (<span class="string">Connect:</span> <span class="number">0</span>, <span class="string">Receive:</span> <span class="number">341</span>, <span class="string">Length:</span> <span class="number">341</span>, <span class="string">Exceptions:</span> <span class="number">341</span>)
Write <span class="string">errors:</span>           <span class="number">0</span>
Total <span class="string">transferred:</span>      <span class="number">35272401</span> bytes
HTML <span class="string">transferred:</span>       <span class="number">35254593</span> bytes
Requests per <span class="string">second:</span>    <span class="number">2.32</span> [#/sec] (mean)
Time per <span class="string">request:</span>       <span class="number">215661.110</span> [ms] (mean)
Time per <span class="string">request:</span>       <span class="number">431.322</span> [ms] (mean, across all concurrent requests)
Transfer <span class="string">rate:</span>          <span class="number">159.72</span> [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
<span class="string">Connect:</span>        <span class="number">0</span>  <span class="number">355</span> <span class="number">3586.5</span>      <span class="number">0</span>   <span class="number">63141</span>
<span class="string">Processing:</span>  <span class="number">1557</span> <span class="number">119576</span> <span class="number">33974.7</span> <span class="number">127335</span>  <span class="number">182963</span>
<span class="string">Waiting:</span>        <span class="number">0</span> <span class="number">33466</span> <span class="number">58718.9</span>      <span class="number">0</span>  <span class="number">182963</span>
<span class="string">Total:</span>       <span class="number">1566</span> <span class="number">119931</span> <span class="number">34207.2</span> <span class="number">127335</span>  <span class="number">210234</span>

Percentage of the requests served within a certain time (ms)
  <span class="number">50</span>%  <span class="number">127335</span>
  <span class="number">66</span>%  <span class="number">127336</span>
  <span class="number">75</span>%  <span class="number">127337</span>
  <span class="number">80</span>%  <span class="number">127337</span>
  <span class="number">90</span>%  <span class="number">151213</span>
  <span class="number">95</span>%  <span class="number">175948</span>
  <span class="number">98</span>%  <span class="number">176152</span>
  <span class="number">99</span>%  <span class="number">177742</span>
 <span class="number">100</span>%  <span class="number">210234</span> (longest request)
</code></pre><p><strong>参考</strong></p>
<p><a href="http://shenwang.blog.ustc.edu.cn/%E5%AE%89%E8%A3%85abapachebench-standalone/" target="_blank" rel="external">http://shenwang.blog.ustc.edu.cn/%E5%AE%89%E8%A3%85abapachebench-standalone/</a><br><a href="http://blog.csdn.net/kimsung/article/details/9422991" target="_blank" rel="external">http://blog.csdn.net/kimsung/article/details/9422991</a><br><a href="https://code.google.com/p/apachebench-standalone/wiki/HowToBuild" target="_blank" rel="external">https://code.google.com/p/apachebench-standalone/wiki/HowToBuild</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debug/">Debug</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Caffe训练分类模型" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/31/Caffe训练分类模型/" class="article-date">
  	<time datetime="2017-08-31T06:27:54.000Z" itemprop="datePublished">2017-08-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/31/Caffe训练分类模型/">Caffe训练分类模型</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>1.安装Caffe</strong></p>
<p>按照官方<a href="https://github.com/BVLC/caffe" target="_blank" rel="external">https://github.com/BVLC/caffe</a>说明进行编译，若使用了较老的cudnn版本，则要在老版本的caffe与新版本的caffe进行合并，具体是将cudnn开头的相关文件替换掉旧版本caffe里的。</p>
<p><strong>2.整理自己的数据</strong></p>
<p>图像文件可以放置在硬盘的任何位置，将训练的图像及label生成一个train.txt文件，然后验证图像和label生成一个val.txt，一起放到caffe/data/mydata文件夹下。</p>
<pre><code>path/to/image/<span class="number">001</span><span class="class">.jpg</span> <span class="number">0</span>
path/to/image/<span class="number">002</span><span class="class">.jpg</span> <span class="number">1</span>
path/to/image/<span class="number">003</span><span class="class">.jpg</span> <span class="number">2</span>
</code></pre><p>在caffe/examples/imagenet中，将创建lmdb文件和mean文件的的几个sh文件拷贝到自己的examples/mytask中，然后修改这两个文件中的几个地址和名称：</p>
<p><strong>修改create_imagenet.sh</strong></p>
<pre><code><span class="comment">//当前路径</span>
EXAMPLE=/home/xxx/caffe/examples/mytask
<span class="comment">//存放train.txt和val.txt的路径，就是data/mydata</span>
DATA=/home/xxx/caffe/data/mydata
<span class="comment">//不变</span>
TOOLS=/home/xxx/caffe/build/tools

<span class="comment">//存放train和val图片文件夹的主目录（这里与txt文件中的目录合起来才是图片目录）</span>
TRAIN_DATA_ROOT=/home/xxx/project-data/
VAL_DATA_ROOT=/home/xxx/project-data/

GLOG_logtostderr=<span class="number">1</span> <span class="variable">$TOOLS</span>/convert_imageset \
    --resize_height=<span class="variable">$RESIZE_HEIGHT</span> \
    --resize_width=<span class="variable">$RESIZE_WIDTH</span> \
    --shuffle \
    <span class="variable">$TRAIN_DATA_ROOT</span> \
    <span class="variable">$DATA</span>/train<span class="class">.txt</span> \
    <span class="variable">$EXAMPLE</span>/train_lmdb  ##修改名称，与prototxt中的对应

echo <span class="string">"Creating val lmdb..."</span>

GLOG_logtostderr=<span class="number">1</span> <span class="variable">$TOOLS</span>/convert_imageset \
    --resize_height=<span class="variable">$RESIZE_HEIGHT</span> \
    --resize_width=<span class="variable">$RESIZE_WIDTH</span> \
    --shuffle \
    <span class="variable">$VAL_DATA_ROOT</span> \
    <span class="variable">$DATA</span>/val<span class="class">.txt</span> \
    <span class="variable">$EXAMPLE</span>/val_lmdb  ##修改名称
</code></pre><p>同理，修改make_imagenet_mean.sh。</p>
<p>分别执行这两个命令，创建文件lmdb数据库和均值mean文件。</p>
<p><strong>3.设置模型</strong></p>
<p>在caffe/models下有很多预制的模型可供使用，模型文件一共可包括至少三个文件：deploy.prototxt；solver.prototxt；train_val.prototxt，有时需要finetune已训练好的模型，还需要一些比如在imagenet上预训练的caffemodel文件。</p>
<p>sovler里面包含超参数和一些信息：</p>
<pre><code><span class="attribute">net</span>: <span class="string">"models/bvlc_googlenet/train_val.prototxt"</span>
<span class="attribute">test_iter</span>: <span class="string">1000</span>
<span class="attribute">test_interval</span>: <span class="string">4000</span>
<span class="attribute">test_initialization</span>: <span class="string">false</span>
<span class="attribute">display</span>: <span class="string">40</span>
<span class="attribute">average_loss</span>: <span class="string">40</span>
<span class="attribute">base_lr</span>: <span class="string">0.01</span>
<span class="attribute">lr_policy</span>: <span class="string">"step"</span>
<span class="attribute">stepsize</span>: <span class="string">320000</span>
<span class="attribute">gamma</span>: <span class="string">0.96</span>
<span class="attribute">max_iter</span>: <span class="string">10000000</span>
<span class="attribute">momentum</span>: <span class="string">0.9</span>
<span class="attribute">weight_decay</span>: <span class="string">0.0002</span>
<span class="attribute">snapshot</span>: <span class="string">40000</span>
<span class="attribute">snapshot_prefix</span>: <span class="string">"models/bvlc_googlenet/bvlc_googlenet"</span>
<span class="attribute">solver_mode</span>: <span class="string">GPU</span>
</code></pre><p>train_val里面的主要修改的地方是batch_size，它与sovler里面的test_iter相乘的结果对应训练图像的总数；修改train和val的sorce文件地址：train_lmdb,val_lmdb. </p>
<pre><code><span class="tag">data_param</span> {
<span class="attribute">source</span>: <span class="string">"examples/imagenet/ilsvrc12_train_lmdb"</span>
<span class="attribute">batch_size</span>: <span class="number">32</span>
<span class="attribute">backend</span>: LMDB
  }
</code></pre><p>PS: 若使用lmdb的话，type为Data，使用图像的话就是ImageData</p>
<pre><code>layer {
  name: <span class="string">"data"</span>
  <span class="keyword">type</span>: <span class="string">"Data"</span>
  top: <span class="string">"data"</span>
  top: <span class="string">"label"</span>
  <span class="keyword">include</span> {
    phase: <span class="type">TRAIN</span>
  }
</code></pre><p>PS: 在finetune残差网络resnet时，网络结构文件中BatchNorm层的参数要注意： </p>
<pre><code><span class="attribute">1.在训练时所有BN层要设置use_global_stats</span>: <span class="string">false（也可以不写，caffe默认是false） </span>
<span class="attribute">2.在测试时所有BN层要设置use_global_stats</span>: <span class="string">true</span>

<span class="cal"><span class="string">#1</span>.训练如果不设为<span class="literal">false</span>，会导致模型不收敛 
<span class="string">#2</span>.测试如果不设置为<span class="literal">true</span>，会导致准确率极低 </span>
</code></pre><p><strong>4.开始训练</strong></p>
<pre><code><span class="shebang">#!/bin/bash</span>
<span class="shebang">#!/usr/bin/env sh</span>
PRETRAINED_MODEL=./models/resnet50/ResNet-<span class="number">50</span>-model.caffemodel
t=$(date +%Y-%m-%d_%H:%M:%S) 
LOG=./<span class="built_in">log</span>/train_res50_<span class="variable">$t</span>.log
GLOG_logtostderr=<span class="number">1</span> ./build/tools/caffe train \
    --solver=./models/resnet50/solver.prototxt \
    --weights=<span class="variable">$PRETRAINED_MODEL</span> \
    --gpu=<span class="number">0</span>,<span class="number">1</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> | tee <span class="variable">$LOG</span>
</code></pre><p>训练时若出现内存不足停止，要减小train_val.prototxt中batchsize的大小。<br>若出现waiting for data，可能是硬盘读写速度慢，那就waiting吧。。。</p>
<p><strong>5.测试</strong></p>
<pre><code><span class="shebang">#!/bin/bash</span>
<span class="shebang">#!/usr/bin/env sh</span>
GLOG_logtostderr=<span class="number">1</span> ./build/tools/caffe <span class="built_in">test</span> \
    --model=./models/resnet50/ResNet-<span class="number">50</span>-train-val.prototxt \
    --weights=./models/resnet50/output_iter_100000.caffemodel \
    --gpu=<span class="number">1</span> \
    --iterations=<span class="number">2000</span>
</code></pre><p><strong>6.分类demo</strong></p>
<p>在caffe/python下的classify.py文件可以用来对图像进行分类，但是没有输出可见的分类结果，需要改写些内容。开始之前需要把mean均值文件转换为.npy格式，代码如下：</p>
<pre><code>import caffe
import numpy as np
import sys

<span class="keyword">if</span> <span class="function"><span class="title">len</span><span class="params">(sys.argv)</span></span> != <span class="number">3</span>:
    print <span class="string">"Usage: python convert_protomean.py proto.mean out.npy"</span>
    sys.<span class="function"><span class="title">exit</span><span class="params">()</span></span>

blob = caffe<span class="class">.proto</span><span class="class">.caffe_pb2</span><span class="class">.BlobProto</span>()
data = <span class="function"><span class="title">open</span><span class="params">( sys.argv[<span class="number">1</span>] , <span class="string">'rb'</span> )</span></span>.<span class="function"><span class="title">read</span><span class="params">()</span></span>
blob.<span class="function"><span class="title">ParseFromString</span><span class="params">(data)</span></span>
arr = np.<span class="function"><span class="title">array</span><span class="params">( caffe.io.blobproto_to_array(blob)</span></span> )
out = arr[<span class="number">0</span>]
np.<span class="function"><span class="title">save</span><span class="params">( sys.argv[<span class="number">2</span>] , out )</span></span>
</code></pre><p><strong>自己改写的classify-demo.py</strong></p>
<pre><code><span class="built_in">import</span> numpy as np
<span class="built_in">import</span> sys
<span class="built_in">import</span> os
<span class="built_in">import</span> caffe
<span class="built_in">import</span> io
<span class="built_in">#</span>from sys <span class="built_in">import</span> argv
<span class="built_in">#</span>input filefolder you want to test
<span class="built_in">#</span>tools,filefolder=argv

caffe.set_device<span class="params">(<span class="number">0</span>)</span> 
caffe.set_mode_gpu<span class="params">()</span>
MODEL_FILE =<span class="string">"../models/googlenet/deploy.prototxt"</span>
PRETRAINED = <span class="string">"../models/googlenet/output/bvlc_googlenet_iter_200000.caffemodel"</span>
MEAN = <span class="string">"mean.npy"</span>

net = caffe.Classifier<span class="params">(MODEL_FILE, PRETRAINED, mean = np.load<span class="params">(MEAN)</span>.mean<span class="params">(<span class="number">1</span>)</span>.mean<span class="params">(<span class="number">1</span>)</span>,
channel_swap=<span class="params">(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>)</span>,
raw_scale=<span class="number">255</span>,
image_dims=<span class="params">(<span class="number">256</span>, <span class="number">256</span>)</span>)</span>

filewriter = open<span class="params">(<span class="string">"../data/mydata/result.txt"</span>,<span class="string">"w+"</span>)</span>
labels_file = '../data/mydata/synset_words.txt'
labels = np.loadtxt<span class="params">(labels_file, str, delimiter='\t')</span>
<span class="built_in">#</span>load groundtruth txt to dictionary
groundtruth_file = '../data/mydata/groundtruth/abc.txt'
dict_data = {}
with open<span class="params">(groundtruth_file, 'r')</span> as df:
    <span class="keyword">for</span> kv in [d.strip<span class="params">()</span>.split<span class="params">(' ')</span> <span class="keyword">for</span> d in df]:
    dict_data[kv[<span class="number">0</span>]] = kv[<span class="number">1</span>]

<span class="keyword">for</span> root,dirs,files in os.walk<span class="params">(<span class="string">"/home/xxx/project_data/mydata/abc/"</span>)</span>: <span class="built_in">#</span> all the images are in test folder

    <span class="keyword">for</span> file in files:
    IMAGE_FILE = os.path.join<span class="params">(root,file)</span>.decode<span class="params">('gbk')</span>.encode<span class="params">('utf8')</span>
    <span class="built_in">#</span>print IMAGE_FILE
    input_image = caffe.io.load_image<span class="params">(IMAGE_FILE)</span>
    prediction = net.predict<span class="params">([input_image])</span>
    string = os.path.basename<span class="params">(IMAGE_FILE)</span>+<span class="string">" "</span>+<span class="built_in">str</span><span class="params">(prediction[<span class="number">0</span>].argmax<span class="params">()</span>)</span>+<span class="string">"\n"</span>
    filewriter.write<span class="params">(string)</span>
    <span class="built_in">#</span>print os.path.basename<span class="params">(IMAGE_FILE)</span>, prediction[<span class="number">0</span>].argmax<span class="params">()</span>
    <span class="built_in">#</span> load ImageNet labels

    label_true=dict_data[os.path.basename<span class="params">(IMAGE_FILE)</span>]
    <span class="keyword">if</span> label_true==<span class="built_in">str</span><span class="params">(prediction[<span class="number">0</span>].argmax<span class="params">()</span>)</span>:
        print os.path.basename<span class="params">(IMAGE_FILE)</span>+<span class="string">" "</span>+labels[prediction[<span class="number">0</span>].argmax<span class="params">()</span>]+' '+'v'
    <span class="keyword">else</span>:
        print os.path.basename<span class="params">(IMAGE_FILE)</span>+<span class="string">" "</span>+labels[prediction[<span class="number">0</span>].argmax<span class="params">()</span>]+' '+'x'

filewriter.close<span class="params">()</span>
</code></pre><p><strong>7.plot训练测试曲线</strong></p>
<p>caffe/tools/extra下包含几个有用的工具，其中包括将日志文件.log绘制出训练阶段的loss变化和测试阶段accuracy的变化情况，具体：</p>
<pre><code>./parse_log.<span class="keyword">sh</span> xxxx.<span class="keyword">log</span> #解析日志，划分为train <span class="keyword">test</span>两个文件

./plot_training_log.py.example 0~7 <span class="keyword">save</span>.png xxxx.<span class="keyword">log</span> #绘制图

<span class="keyword">Notes</span>:  
    1. Supporting multiple logs.  
    2. <span class="keyword">Log</span> <span class="keyword">file</span> name must end with the lower-cased <span class="string">".log"</span>.  
Supported chart types:  
    0: <span class="keyword">Test</span> accuracy  vs. Iters  
    1: <span class="keyword">Test</span> accuracy  vs. Seconds  
    2: <span class="keyword">Test</span> loss  vs. Iters  
    3: <span class="keyword">Test</span> loss  vs. Seconds  
    4: Train learning rate  vs. Iters  
    5: Train learning rate  vs. Seconds  
    6: Train loss  vs. Iters  
    7: Train loss  vs. Seconds  
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DeepLearning/">DeepLearning</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-python+opencv图像二值化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/25/python+opencv图像二值化/" class="article-date">
  	<time datetime="2017-08-25T08:20:01.000Z" itemprop="datePublished">2017-08-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/25/python+opencv图像二值化/">python+opencv图像二值化</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>Goal</strong></p>
<p>In this tutorial, you will learn Simple thresholding, Adaptive thresholding, Otsu’s thresholding etc.<br>You will learn these functions : cv2.threshold, cv2.adaptiveThreshold etc.</p>
<p><strong>Simple Thresholding</strong></p>
<p>Here, the matter is straight forward. If pixel value is greater than a threshold value, it is assigned one value (may be white), else it is assigned another value (may be black). The function used is cv2.threshold. First argument is the source image, which should be a grayscale image. Second argument is the threshold value which is used to classify the pixel values. Third argument is the maxVal which represents the value to be given if pixel value is more than (sometimes less than) the threshold value. OpenCV provides different styles of thresholding and it is decided by the fourth parameter of the function. Different types are:</p>
<pre><code>cv2<span class="class">.THRESH_BINARY</span>
cv2<span class="class">.THRESH_BINARY_INV</span>
cv2<span class="class">.THRESH_TRUNC</span>
cv2<span class="class">.THRESH_TOZERO</span>
cv2.THRESH_TOZERO_INV
</code></pre><p>Documentation clearly explain what each type is meant for. Please check out the documentation.</p>
<p>Two outputs are obtained. First one is a retval which will be explained later. Second output is our thresholded image.</p>
<p><strong>code:</strong></p>
<pre><code><span class="comment">#!/usr/bin/python</span>
<span class="comment"># -*- coding: UTF-8 -*-</span>
<span class="keyword">import</span> cv2
<span class="keyword">import</span> numpy <span class="keyword">as</span> np
<span class="keyword">from</span> PIL <span class="keyword">import</span> Image 
<span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt
<span class="keyword">import</span> matplotlib
<span class="keyword">import</span> os
<span class="keyword">import</span> sys
reload(sys) 
sys.setdefaultencoding(<span class="string">'utf-8'</span>) 

fln=<span class="string">'76.jpg'</span>
img = cv2.imread(fln,<span class="number">0</span>)
ret,thresh1 = cv2.threshold(img,<span class="number">127</span>,<span class="number">255</span>,cv2.THRESH_BINARY)
ret,thresh2 = cv2.threshold(img,<span class="number">127</span>,<span class="number">255</span>,cv2.THRESH_BINARY_INV)
ret,thresh3 = cv2.threshold(img,<span class="number">127</span>,<span class="number">255</span>,cv2.THRESH_TRUNC)
ret,thresh4 = cv2.threshold(img,<span class="number">127</span>,<span class="number">255</span>,cv2.THRESH_TOZERO)
ret,thresh5 = cv2.threshold(img,<span class="number">127</span>,<span class="number">255</span>,cv2.THRESH_TOZERO_INV)
titles = [<span class="string">'Original_Image'</span>,<span class="string">'BINARY'</span>,<span class="string">'BINARY_INV'</span>,<span class="string">'TRUNC'</span>,<span class="string">'TOZERO'</span>,<span class="string">'TOZERO_INV'</span>]
images = [img, thresh1, thresh2, thresh3, thresh4, thresh5]
<span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">6</span>):
    cv2.imwrite(<span class="string">'0_'</span>+titles[i]+<span class="string">'.jpg'</span>,images[i])
    plt.subplot(<span class="number">2</span>,<span class="number">3</span>,i+<span class="number">1</span>),plt.imshow(images[i],<span class="string">'gray'</span>)

    plt.title(titles[i])
    plt.xticks([]), plt.yticks([])

plt.savefig(<span class="string">'res_'</span>+fln)
plt.show()
</code></pre><h2 id=""><img src="http://docs.opencv.org/master/threshold.jpg" alt="http://docs.opencv.org/master/threshold.jpg"></h2><p><strong>Adaptive Thresholding</strong></p>
<p>In the previous section, we used a global value as threshold value. But it may not be good in all the conditions where image has different lighting conditions in different areas. In that case, we go for adaptive thresholding. In this, the algorithm calculate the threshold for a small regions of the image. So we get different thresholds for different regions of the same image and it gives us better results for images with varying illumination.</p>
<p>It has three ‘special’ input params and only one output argument.</p>
<p>Adaptive Method - It decides how thresholding value is calculated.</p>
<pre><code>cv2.ADAPTIVE_THRESH_MEAN_C : threshold <span class="built_in">value</span> is <span class="operator">the</span> mean <span class="operator">of</span> neighbourhood area.
cv2.ADAPTIVE_THRESH_GAUSSIAN_C : threshold <span class="built_in">value</span> is <span class="operator">the</span> weighted <span class="built_in">sum</span> <span class="operator">of</span> neighbourhood values where weights are <span class="operator">a</span> gaussian window.
Block Size - It decides <span class="operator">the</span> size <span class="operator">of</span> neighbourhood area.
</code></pre><p>C - It is just a constant which is subtracted from the mean or weighted mean calculated.</p>
<p>Below piece of code compares global thresholding and adaptive thresholding for an image with varying illumination:</p>
<pre><code>import cv2
import numpy as np
from matplotlib import pyplot as plt
<span class="tag">img</span> = cv2.<span class="function"><span class="title">imread</span><span class="params">(<span class="string">'sudoku.png'</span>,<span class="number">0</span>)</span></span>
<span class="tag">img</span> = cv2.<span class="function"><span class="title">medianBlur</span><span class="params">(img,<span class="number">5</span>)</span></span>
ret,th1 = cv2.<span class="function"><span class="title">threshold</span><span class="params">(img,<span class="number">127</span>,<span class="number">255</span>,cv2.THRESH_BINARY)</span></span>
th2 = cv2.adaptiveThreshold(<span class="tag">img</span>,<span class="number">255</span>,cv2<span class="class">.ADAPTIVE_THRESH_MEAN_C</span>,\
            cv2<span class="class">.THRESH_BINARY</span>,<span class="number">11</span>,<span class="number">2</span>)
th3 = cv2.adaptiveThreshold(<span class="tag">img</span>,<span class="number">255</span>,cv2<span class="class">.ADAPTIVE_THRESH_GAUSSIAN_C</span>,\
            cv2<span class="class">.THRESH_BINARY</span>,<span class="number">11</span>,<span class="number">2</span>)
titles = [<span class="string">'Original Image'</span>, <span class="string">'Global Thresholding (v = 127)'</span>,
            <span class="string">'Adaptive Mean Thresholding'</span>, <span class="string">'Adaptive Gaussian Thresholding'</span>]
images = [<span class="tag">img</span>, th1, th2, th3]
<span class="keyword">for</span> <span class="tag">i</span> <span class="keyword">in</span> <span class="function"><span class="title">xrange</span><span class="params">(<span class="number">4</span>)</span></span>:
    plt.<span class="function"><span class="title">subplot</span><span class="params">(<span class="number">2</span>,<span class="number">2</span>,i+<span class="number">1</span>)</span></span>,plt.<span class="function"><span class="title">imshow</span><span class="params">(images[i],<span class="string">'gray'</span>)</span></span>
    plt.<span class="function"><span class="title">title</span><span class="params">(titles[i])</span></span>
    plt.<span class="function"><span class="title">xticks</span><span class="params">([])</span></span>,plt.<span class="function"><span class="title">yticks</span><span class="params">([])</span></span>
plt.<span class="function"><span class="title">show</span><span class="params">()</span></span>    
</code></pre><p><img src="http://docs.opencv.org/master/ada_threshold.jpg" alt="result"></p>
<hr>
<p><strong>Otsu’s Binarization</strong></p>
<p>In the first section, I told you there is a second parameter retVal. Its use comes when we go for Otsu’s Binarization. So what is it?</p>
<p>In global thresholding, we used an arbitrary value for threshold value, right? So, how can we know a value we selected is good or not? Answer is, trial and error method. But consider a bimodal image (In simple words, bimodal image is an image whose histogram has two peaks). For that image, we can approximately take a value in the middle of those peaks as threshold value, right ? That is what Otsu binarization does. So in simple words, it automatically calculates a threshold value from image histogram for a bimodal image. (For images which are not bimodal, binarization won’t be accurate.)</p>
<p>For this, our cv2.threshold() function is used, but pass an extra flag, cv2.THRESH_OTSU. For threshold value, simply pass zero. Then the algorithm finds the optimal threshold value and returns you as the second output, retVal. If Otsu thresholding is not used, retVal is same as the threshold value you used.</p>
<p>Check out below example. Input image is a noisy image. In first case, I applied global thresholding for a value of 127. In second case, I applied Otsu’s thresholding directly. In third case, I filtered image with a 5x5 gaussian kernel to remove the noise, then applied Otsu thresholding. See how noise filtering improves the result.</p>
<pre><code><span class="built_in">import</span> cv2
<span class="built_in">import</span> numpy as np
from matplotlib <span class="built_in">import</span> pyplot as plt
img = cv2.imread<span class="params">('noisy2.png',<span class="number">0</span>)</span>
<span class="built_in">#</span> global thresholding
ret1,th1 = cv2.threshold<span class="params">(img,<span class="number">127</span>,<span class="number">255</span>,cv2.THRESH_BINARY)</span>
<span class="built_in">#</span> Otsu's thresholding
ret2,th2 = cv2.threshold<span class="params">(img,<span class="number">0</span>,<span class="number">255</span>,cv2.THRESH_BINARY+cv2.THRESH_OTSU)</span>
<span class="built_in">#</span> Otsu's thresholding after Gaussian filtering
blur = cv2.GaussianBlur<span class="params">(img,<span class="params">(<span class="number">5</span>,<span class="number">5</span>)</span>,<span class="number">0</span>)</span>
ret3,th3 = cv2.threshold<span class="params">(blur,<span class="number">0</span>,<span class="number">255</span>,cv2.THRESH_BINARY+cv2.THRESH_OTSU)</span>
<span class="built_in">#</span> plot all the images and their histograms
images = [img, <span class="number">0</span>, th1,
          img, <span class="number">0</span>, th2,
          blur, <span class="number">0</span>, th3]
titles = ['Original Noisy Image','Histogram','Global Thresholding <span class="params">(v=<span class="number">127</span>)</span>',
          'Original Noisy Image','Histogram',<span class="string">"Otsu's Thresholding"</span>,
          'Gaussian filtered Image','Histogram',<span class="string">"Otsu's Thresholding"</span>]
<span class="keyword">for</span> i in xrange<span class="params">(<span class="number">3</span>)</span>:
    plt.subplot<span class="params">(<span class="number">3</span>,<span class="number">3</span>,i*<span class="number">3</span>+<span class="number">1</span>)</span>,plt.imshow<span class="params">(images[i*<span class="number">3</span>],'gray')</span>
    plt.title<span class="params">(titles[i*<span class="number">3</span>])</span>, plt.xticks<span class="params">([])</span>, plt.yticks<span class="params">([])</span>
    plt.subplot<span class="params">(<span class="number">3</span>,<span class="number">3</span>,i*<span class="number">3</span>+<span class="number">2</span>)</span>,plt.hist<span class="params">(images[i*<span class="number">3</span>].ravel<span class="params">()</span>,<span class="number">256</span>)</span>
    plt.title<span class="params">(titles[i*<span class="number">3</span>+<span class="number">1</span>])</span>, plt.xticks<span class="params">([])</span>, plt.yticks<span class="params">([])</span>
    plt.subplot<span class="params">(<span class="number">3</span>,<span class="number">3</span>,i*<span class="number">3</span>+<span class="number">3</span>)</span>,plt.imshow<span class="params">(images[i*<span class="number">3</span>+<span class="number">2</span>],'gray')</span>
    plt.title<span class="params">(titles[i*<span class="number">3</span>+<span class="number">2</span>])</span>, plt.xticks<span class="params">([])</span>, plt.yticks<span class="params">([])</span>
plt.show<span class="params">()</span>
</code></pre><h2 id="-1"><img src="http://docs.opencv.org/master/otsu.jpg" alt="http://docs.opencv.org/master/otsu.jpg"></h2><p>Link:</p>
<p><a href="http://docs.opencv.org/master/d7/d4d/tutorial_py_thresholding.html" target="_blank" rel="external">http://docs.opencv.org/master/d7/d4d/tutorial_py_thresholding.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debug/">Debug</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Tesseract4.0+jTessBoxEditor训练(ubuntu下)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/25/Tesseract4.0+jTessBoxEditor训练(ubuntu下)/" class="article-date">
  	<time datetime="2017-08-25T07:48:57.000Z" itemprop="datePublished">2017-08-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/25/Tesseract4.0+jTessBoxEditor训练(ubuntu下)/">Tesseract4.0+jTessBoxEditor训练(ubuntu下)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>下载jTessBoxEditor</strong></p>
<p><a href="https://sourceforge.net/projects/vietocr/files/" target="_blank" rel="external">https://sourceforge.net/projects/vietocr/files/</a></p>
<pre><code>unzip jTessBoxEditor-<span class="number">2.0</span>-Beta<span class="class">.zip</span>
cd jTessBoxEditor
java -Xms128m -Xmx1024m -jar jTessBoxEditor<span class="class">.jar</span>  #打开可视化界面
</code></pre><p>—- <strong>训练</strong> —-</p>
<p><strong>预处理</strong></p>
<p>把所有待训练的图像转换为tiff格式（可使用ubuntu下的imageMagick的convert命令或mogrify命令批量处理）</p>
<pre><code>mogrify -<span class="built_in">path</span> ./TIFF/ -<span class="built_in">format</span> tiff *.jpg
</code></pre><p>然后采用jTessBoxEditor中的<code>tools/Merge Tiff</code>功能，将待训练的tiff图像合并为一个tiff文件，在可视化界面中先选中所有tiff文件，然后点击OK，然后在再次弹出的窗口中输入要合并的tiff文件的名称，例如chi.wang.exp0.tif，chi表示中文，wang表示字体。</p>
<p><strong>生成.box 文件</strong></p>
<pre><code>sudo tesseract chi<span class="class">.wang</span><span class="class">.exp0</span><span class="class">.tif</span> chi<span class="class">.wang</span><span class="class">.exp0</span> batch<span class="class">.nochop</span> makebox
</code></pre><p>or</p>
<pre><code><span class="tag">sudo</span> <span class="tag">tesseract</span> <span class="tag">chi</span><span class="class">.wang</span><span class="class">.exp0</span><span class="class">.tif</span> <span class="tag">chi</span><span class="class">.wang</span><span class="class">.exp0</span> <span class="tag">-l</span> <span class="tag">chi_smi</span> <span class="tag">-psm</span> 7 <span class="tag">digits</span> <span class="tag">batch</span><span class="class">.nochop</span> <span class="tag">makebox</span> # 数字
</code></pre><p>会生成一个名为chi.wang.exp0.box文件</p>
<p><strong>使用jTessBoxEditor校正字符</strong></p>
<p>在可视化界面中，在<code>Box Editor</code>面板中点击open按钮打开合并的tiff文件，然后每一页每一页的去矫正矩形框的位置以及正确的识别字符，亦可以同时修改chi.wang.exp0.box文件来添加一下empty pages的识别框！</p>
<p><strong>生成自制语言库</strong></p>
<pre><code>sudo tesseract chi<span class="class">.wang</span><span class="class">.exp0</span><span class="class">.tif</span> chi<span class="class">.wang</span><span class="class">.exp0</span> nobatch box<span class="class">.train</span> #生成字符特征文件

sudo unicharset_extractor chi<span class="class">.wang</span><span class="class">.exp0</span><span class="class">.box</span>  #产生字符集

vim font_properties
wang <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> #向新生成的文件font_properties中录入此内容，普通字体，不加粗，不倾斜

sudo shapeclustering -F font_properties -U unicharset chi<span class="class">.wang</span><span class="class">.exp0</span><span class="class">.tr</span>  #生成shapetable

sudo mftraining -F font_properties -U unicharset chi<span class="class">.wang</span><span class="class">.exp0</span><span class="class">.tr</span> #聚集字符特征

sudo cntraining chi<span class="class">.wang</span><span class="class">.exp0</span><span class="class">.tr</span>  #生成字符形状正常变化特征文件normproto
</code></pre><p><strong>重命名如下文件</strong>：</p>
<pre><code><span class="title">inttemp</span>
├──
normproto
├──
pffmtable
├──
shapetable
└──
unicharset
</code></pre><p>为</p>
<pre><code>wang<span class="class">.inttemp</span>
├──
wang<span class="class">.normproto</span>
├──
wang<span class="class">.pffmtable</span>
├──
wang<span class="class">.shapetable</span>
└──
wang.unicharset
</code></pre><p><strong>生成语言库</strong></p>
<pre><code>sudo <span class="keyword">combine_t</span>essdata wang.
</code></pre><p>此时得到了训练好的wang.traineddata</p>
<pre><code>sudo cp wang<span class="class">.traineddata</span> /usr/share/tesseract-ocr/tessdata/wang<span class="class">.traineddata</span>  #复制到安装目录
</code></pre><p><strong>测试</strong></p>
<pre><code>tesseract <span class="number">1</span><span class="class">.jpg</span> <span class="number">1</span> -l wang 
</code></pre><hr>
<p>上述命令可能会出错，得到如下输出：</p>
<pre><code>FAIL!
APPLY_BOXES: boxfile line <span class="number">22</span>/园 ((<span class="number">1108</span>,<span class="number">4637</span>),(<span class="number">1150</span>,<span class="number">4686</span>)): FAILURE! Couldn<span class="comment">'t find a matching blob</span>
FAIL!
APPLY_BOXES: boxfile line <span class="number">25</span>/园 ((<span class="number">1258</span>,<span class="number">4641</span>),(<span class="number">1300</span>,<span class="number">4689</span>)): FAILURE! Couldn<span class="comment">'t find a matching blob</span>
APPLY_BOXES:
   Boxes read <span class="keyword">from</span> boxfile:      <span class="number">40</span>
   Boxes failed resegmentation:       <span class="number">2</span>
   Found <span class="number">38</span> good blobs.
Generated training data <span class="keyword">for</span> <span class="number">4</span> words
Warning <span class="keyword">in</span> pixReadMemTiff: tiff page <span class="number">1</span> <span class="keyword">not</span> found
</code></pre><p>意味着<code>园</code>字的块没找到，tr文件中就缺失了<code>园</code>字的特征。如果出现FATALITIES错误，必须先修正box文件修订错误才能继续。FATALITY通常意味着没有找到box文件中的任何字体。要么是坐标错误，要么是字符图像出了问题。如果字符没有可供使用的样本，它就不能被识别，那么得到的inttemp文件和unicharset文件就不匹配，Tesseract会退出。</p>
<p>如果tif/box文件对是通过jTessBoxEditor可视化工具得到的，那么生成文件时选定<code>Anti-Aliasing</code>可消除上述错误。</p>
<hr>
<p>参考link：</p>
<p><a href="http://qianjiye.de/2015/08/tesseract-ocr" target="_blank" rel="external">http://qianjiye.de/2015/08/tesseract-ocr</a></p>
<p><a href="http://lib.csdn.net/article/deeplearning/50598" target="_blank" rel="external">http://lib.csdn.net/article/deeplearning/50598</a></p>
<p><a href="http://www.jianshu.com/p/31afd7fc5813" target="_blank" rel="external">http://www.jianshu.com/p/31afd7fc5813</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DeepLearning/">DeepLearning</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ubuntu16.04+python2.7中文编码" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/25/ubuntu16.04+python2.7中文编码/" class="article-date">
  	<time datetime="2017-08-25T07:11:31.000Z" itemprop="datePublished">2017-08-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/25/ubuntu16.04+python2.7中文编码/">ubuntu16.04+python2.7中文编码</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>文件头添加</strong>：</p>
<pre><code><span class="shebang">#!/usr/bin/python</span>
# -*- coding: UTF-<span class="number">8</span> -*-
</code></pre><p><strong>代码中添加</strong>：</p>
<pre><code>import sys
<span class="function"><span class="title">reload</span><span class="params">(sys)</span></span> 
sys.<span class="function"><span class="title">setdefaultencoding</span><span class="params">(<span class="string">'utf-8'</span>)</span></span>
</code></pre><p><strong>执行代码即可</strong>：</p>
<pre><code><span class="keyword">if</span> <span class="function"><span class="title">isinstance</span><span class="params">(ss, unicode)</span></span>: 
   #<span class="function"><span class="title">unicode</span><span class="params">(<span class="string">"中文字符"</span>)</span></span>.<span class="function"><span class="title">encode</span><span class="params">(<span class="string">"utf-8"</span>)</span></span>
   ss =  <span class="function"><span class="title">unicode</span><span class="params">(ss)</span></span>.<span class="function"><span class="title">encode</span><span class="params">(<span class="string">"utf-8"</span>)</span></span>
   print ss
</code></pre><hr>
<p><strong>matplotlib绘图中中文乱码情况解决</strong></p>
<p><strong>查看ubuntu中文字体</strong></p>
<pre><code><span class="variable">$ </span>fc-list <span class="symbol">:lang=zh-cn</span>
</code></pre><p><strong>安装中文字体</strong></p>
<pre><code><span class="title">sudo</span> apt-get install -y --force-<span class="built_in">yes</span> --<span class="built_in">no</span>-install-recommends fonts-wqy-microhei
</code></pre><p>再次查看<code>fc-list :lang=zh-cn</code></p>
<p><strong>其中输出</strong>：</p>
<pre><code><span class="regexp">/usr/</span>share<span class="regexp">/fonts/</span>truetype<span class="regexp">/wqy/</span>wqy-microhei.<span class="string">ttc:</span> WenQuanYi Micro Hei,文泉驛微米黑,文泉驿微米黑:style=Regular
</code></pre><p><strong>复制ttc文件地址</strong></p>
<pre><code><span class="regexp">/usr/</span>share<span class="regexp">/fonts/</span>truetype<span class="regexp">/wqy/</span>wqy-microhei.ttc
</code></pre><p><strong>在python代码中</strong>：</p>
<pre><code>zhfont = matplotlib<span class="class">.font_manager</span><span class="class">.FontProperties</span>(fname=<span class="string">'/usr/share/fonts/truetype/wqy/wqy-microhei.ttc'</span>)
plt.<span class="function"><span class="title">title</span><span class="params">(unicode(ss)</span></span>.<span class="function"><span class="title">encode</span><span class="params">(<span class="string">"utf-8"</span>)</span></span>, <span class="attribute">color</span>=<span class="string">'white'</span>, fontproperties= zhfont)
</code></pre><p>即可解决！！</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debug/">Debug</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ubuntu16.04+Tesseract4.0" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/08/25/ubuntu16.04+Tesseract4.0/" class="article-date">
  	<time datetime="2017-08-25T07:06:09.000Z" itemprop="datePublished">2017-08-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/25/ubuntu16.04+Tesseract4.0/">ubuntu16.04+Tesseract4.0</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The build instructions for Linux also apply to other UNIX like operating systems.</p>
<p><strong>安装依赖Dependencies</strong></p>
<p>A compiler for C and C++: GCC or Clang<br>GNU Autotools: autoconf, automake, libtool<br>autoconf-archive<br>pkg-config<br>Leptonica<br>libpng, libjpeg, libtiff</p>
<p><strong>Ubuntu</strong></p>
<p>If they are not already installed, you need the following libraries (Ubuntu 16.04/14.04):</p>
<pre><code>sudo apt-get <span class="operator"><span class="keyword">install</span> g++ # <span class="keyword">or</span> clang++ (presumably)
sudo apt-<span class="keyword">get</span> <span class="keyword">install</span> autoconf automake libtool
sudo apt-<span class="keyword">get</span> <span class="keyword">install</span> autoconf-archive
sudo apt-<span class="keyword">get</span> <span class="keyword">install</span> pkg-config
sudo apt-<span class="keyword">get</span> <span class="keyword">install</span> libpng12-dev
sudo apt-<span class="keyword">get</span> <span class="keyword">install</span> libjpeg8-dev
sudo apt-<span class="keyword">get</span> <span class="keyword">install</span> libtiff5-dev
sudo apt-<span class="keyword">get</span> <span class="keyword">install</span> zlib1g-dev</span>
</code></pre><p>if you plan to install the training tools, you also need the following libraries:</p>
<pre><code>sudo apt-<span class="built_in">get</span> install libicu-<span class="built_in">dev</span>
sudo apt-<span class="built_in">get</span> install libpango1.0-<span class="built_in">dev</span>
sudo apt-<span class="built_in">get</span> install libcairo2-<span class="built_in">dev</span>
</code></pre><p><strong>Leptonica</strong></p>
<p>You also need to install Leptonica. Ensure that the development headers for Leptonica are installed before compiling Tesseract.</p>
<p>Tesseract versions and the minimum version of Leptonica required:</p>
<p>Tesseract    Leptonica    Ubuntu<br>4.00    1.74.2    Must build from source<br>3.05    1.74.0    Must build from source<br>3.04    1.71    Ubuntu 16.04<br>3.03    1.70    Ubuntu 14.04<br>3.02    1.69    Ubuntu 12.04<br>3.01    1.67    </p>
<p>One option is to install the distro’s Leptonica package:</p>
<pre><code>sudo apt-<span class="built_in">get</span> install libleptonica-<span class="built_in">dev</span>
</code></pre><p>but if you are using an oldish version of Linux, the Leptonica version may be too old, so you will need to build from source.</p>
<p>The sources are at<a href="https://github.com/DanBloomberg/leptonica" target="_blank" rel="external"> https://github.com/DanBloomberg/leptonica</a> . The instructions for building are given in Leptonica README.</p>
<p><strong>Leptonica 1.74.4</strong></p>
<pre><code>git clone --recursive http<span class="variable">s:</span>//github.<span class="keyword">com</span>/DanBloomberg/leptonica
<span class="keyword">cd</span> leptonica

./autobuild
./configure
./<span class="keyword">make</span>-<span class="keyword">for</span>-auto

sudo <span class="keyword">make</span>
sudo <span class="keyword">make</span> install
</code></pre><p><strong>Tesseract 4.0</strong> </p>
<pre><code>git clone --depth <span class="number">1</span>  http<span class="variable">s:</span>//github.<span class="keyword">com</span>/tesseract-ocr/tesseract.git tesseract
<span class="keyword">cd</span> tesseract
./autogen.<span class="keyword">sh</span>
./configure --enable-<span class="keyword">debug</span>
LDFLAGS=<span class="string">"-L/usr/local/lib"</span> CFLAGS=<span class="string">"-I/usr/local/include"</span> <span class="keyword">make</span>
sudo <span class="keyword">make</span> install
sudo ldconfig 
</code></pre><p>build training tools if you like: </p>
<pre><code><span class="built_in">make</span> training
sudo <span class="built_in">make</span> training-install 
</code></pre><p><strong>test Tesseract </strong></p>
<pre><code>$ tesseract imagename outputbase [-l lang] [--psm pagesegmode] [configfiles...]
$ tesseract <span class="number">1</span><span class="class">.jpg</span> <span class="number">1</span><span class="class">.txt</span> -l chi_sim
</code></pre><hr>
<p><strong>Error:</strong></p>
<pre><code><span class="keyword">Error</span> opening data file /usr/local/share/eng.traineddata
Please make sure the TESSDATA_PREFIX environment variable <span class="keyword">is</span> <span class="keyword">set</span> <span class="keyword">to</span> your <span class="string">"tessdata"</span> directory.
Failed loading language <span class="comment">'eng'</span>
Tesseract couldn<span class="comment">'t load any languages!</span>
Could <span class="keyword">not</span> initialize tesseract.
</code></pre><p><strong>办法：下载语言包</strong></p>
<p><a href="https://github.com/tesseract-ocr/tessdata/blob/master/eng.traineddata" target="_blank" rel="external">https://github.com/tesseract-ocr/tessdata/blob/master/eng.traineddata</a></p>
<p><a href="https://github.com/tesseract-ocr/tessdata" target="_blank" rel="external">https://github.com/tesseract-ocr/tessdata</a>  #These language data files only work with Tesseract 4.0</p>
<pre><code>sudo mv eng.traineddata <span class="regexp">/usr/</span>share<span class="regexp">/tesseract-ocr/</span>tessdata

export TESSDATA_PREFIX=<span class="regexp">/usr/</span>share<span class="regexp">/tesseract-ocr/</span>tessdata
</code></pre><p>or</p>
<pre><code>sudo mv <span class="regexp">/usr/</span>local<span class="regexp">/share/</span>tessdata <span class="regexp">/usr/</span>local<span class="regexp">/share/</span>tessdata.bak
sudo ln -s <span class="regexp">/usr/</span>share<span class="regexp">/tesseract-ocr/</span>tessdata <span class="regexp">/usr/</span>local<span class="regexp">/share/</span>
</code></pre><p><strong>安装python接口</strong></p>
<pre><code>sudo pip <span class="keyword">install</span> pytesseract
</code></pre><p>比如识别中文及数字: </p>
<pre><code>tessdata_dir_config=<span class="string">'-psm 7 digits'</span>
ss = pytesseract.<span class="function"><span class="title">image_to_string</span><span class="params">(image, lang=<span class="string">'chi_sim'</span>, config=tessdata_dir_config)</span></span>
</code></pre><p><strong>修改配置文件</strong></p>
<p>当使用命令参数 digits来识别数字时，有考虑识别字母和数字，即可在系统tesseract所在位置修改配置文件：<code>usr/share/tesseract-orc/tessdata/configs/digits</code></p>
<pre><code>tessedit_chaar_whitelist <span class="number">0123456789</span>-. <span class="hexcolor">#def</span>ault

tessedit_chaar_whitelist ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-.
</code></pre><hr>
<p>PS：图片太大时识别不好，缩放到指甲盖大小反而识别会好些。。。</p>
<hr>
<p><strong>link</strong>: </p>
<p><a href="https://www.youtube.com/watch?v=vOdnt2h1U8U" target="_blank" rel="external">https://www.youtube.com/watch?v=vOdnt2h1U8U</a></p>
<p><a href="https://lengerrong.blogspot.com/2017/03/how-to-build-latest-tesseract-leptonica.html" target="_blank" rel="external">https://lengerrong.blogspot.com/2017/03/how-to-build-latest-tesseract-leptonica.html</a></p>
<p><a href="https://github.com/tesseract-ocr/tesseract/wiki/Compiling-%E2%80%93-GitInstallation" target="_blank" rel="external">https://github.com/tesseract-ocr/tesseract/wiki/Compiling-%E2%80%93-GitInstallation</a></p>
<p><a href="https://github.com/tesseract-ocr/tesseract/wiki/Compiling#linux" target="_blank" rel="external">https://github.com/tesseract-ocr/tesseract/wiki/Compiling#linux</a></p>
<p><a href="https://lucacerone.net/2017/install-tesseract-3-0-5-in-ubuntu-16-04/" target="_blank" rel="external">https://lucacerone.net/2017/install-tesseract-3-0-5-in-ubuntu-16-04/</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DeepLearning/">DeepLearning</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Research/">Research</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Gang Wang
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>